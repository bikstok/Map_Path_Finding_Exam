<!DOCTYPE html>
<html>
<head>
  <title>Storkøbenhavn Korteste Vej Finder</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    #map {height:600px;width:100%;}
    #controls {margin:10px;}
  </style>
</head>
<body>
  <h2>Storkøbenhavn Korteste Vej Finder</h2>

  <div id="controls">
    <button id="algoBtn">Skift algoritme</button>
    <span>Valgt algoritme: <span id="currentAlgo">A*</span></span>
  </div>

  <div id="map"></div>

  <script>
    const map = L.map('map').setView([55.676,12.558],12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

    let clicks = [];
    let markers = [];
    let algorithm = 'astar';
    const algoOptions = ['A*','dfs','dijkstra'];
    let algoIndex = 0;

    const algoBtn = document.getElementById('algoBtn');
    const currentAlgoLabel = document.getElementById('currentAlgo');

    algoBtn.addEventListener('click', ()=>{
      algoIndex = (algoIndex+1)%algoOptions.length;
      algorithm = algoOptions[algoIndex];
      currentAlgoLabel.textContent = algorithm.toUpperCase();
    });

    map.on('click', e=>{
      clicks.push(e.latlng);

      // Tilføj markør
      const marker = L.marker(e.latlng).addTo(map);
      markers.push(marker);

      if(clicks.length === 2){
        fetch('/api/route',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            startLat: clicks[0].lat,
            startLng: clicks[0].lng,
            endLat: clicks[1].lat,
            endLng: clicks[1].lng,
            algorithm
          })
        })
        .then(res=>res.json())
        .then(data=>{
          if(!data || !data.path){
            alert('Ingen rute fundet!');
            cleanup();
            return;
          }

          const route = data.path.map(n=>{
            const [lat,lng] = n.split(',').map(Number);
            return [lat,lng];
          });

          // Tegn ruten
          L.polyline(route,{color:'blue',weight:5}).addTo(map);

          // Vis distance og beregningstid
          alert(`Rute fundet!
Distance: ${data.distanceKm} km
Besøgte noder: ${data.visitedNodes.length}
Beregnings tid: ${data.durationMs} ms`);

          cleanup();
        });
      }
    });

    function cleanup(){
      clicks = [];
      markers.forEach(m => map.removeLayer(m));
      markers = [];
    }
  </script>
</body>
</html>
